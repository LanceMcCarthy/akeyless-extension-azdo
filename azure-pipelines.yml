trigger:
  branches:
    include:
    - main
  paths:
   include:
     - 'azure-pipelines.yml'
     - 'tasks/**/*'

jobs:
# Job 1 - USes https://marketplace.visualstudio.com/items?itemName=Akeyless-Engineering.akeyless-secrets-management
  # - job: Akeyless_Official
  #   pool:
  #     vmImage: 'windows-latest'
  #   steps:
  #   # Get JWT from Azure Service Principal so we can use it for the akeyless-auth@0 task
  #   - task: AzureCLI@2
  #     name: 'AzureCLI'
  #     inputs:
  #       azureSubscription: 'Azure MSA Account'
  #       scriptType: ps
  #       scriptLocation: inlineScript
  #       inlineScript: |
  #         $JWT=$(az account get-access-token --query accessToken --output tsv)
  #         echo "##vso[task.setvariable variable=azure_jwt;isoutput=true;issecret=true]$JWT"
  #     displayName: 'Get JWT from Azure Service Principal'

  #   # Important: The 'connectedServiceName` is a service you've added in your AzDO project settings. It simply holds your Akeyless Access ID (ex. 'p-xxxxxxx').
  #   # Once you have a valid Akeyless token, you can use it to retrieve static and dynamic secrets later
  #   - task: akeyless-auth@0
  #     name: AkeylessAuth
  #     inputs:
  #       connectedServiceName: 'PersonalAkeylessVault'
  #       jwt: '$(AzureCLI.azure_jwt)'
  #     displayName: 'Get Akeyless Access Token'

  #   # Static secrets retrieval

  #   - task: akeyless-get-secrets-value-task@0
  #     inputs:
  #       connectedServiceName: 'PersonalAkeylessVault'
  #       token: '$(AkeylessAuth.akeylessToken)'
  #       secretsPaths: 'nuget_key=/progress/TELERIK_NUGET_KEY,my_cool_secret=/samples/azdo-test-secret'
  #     displayName: 'Get Static Secrets'

  #   - powershell: |
  #       echo "---------------------------------------------"
  #       echo "Static secrets can simply be referenced by the"
  #       echo "output variable name you set in the task input."
  #       echo "---------------------------------------------"
        
  #       echo "Verifying static secrets..."
  #       echo "nuget_key: $(nuget_key)"
  #       echo "my_cool_secret: $(my_cool_secret)"
  #     displayName: 'Checking static Secrets'

  #   # Dynamic secrets retrieval

  #   - task: akeyless-get-dynamic-secret-value-task@0
  #     name: AkeylessSqlDynamic
  #     inputs:
  #       connectedServiceName: 'PersonalAkeylessVault'
  #       token: '$(AkeylessAuth.akeylessToken)'
  #       name: '/az-dvlup-sqlsrvsecret'
  #       timeout: 30
  #     displayName: 'Get SQL Dynamic Secret'

  #   - powershell: |
  #       echo "Verifying SQL dynamic secret..."
  #       echo "$(AkeylessSqlDynamic.dynamicSecretValue)"
  #     displayName: 'Checking Secrets'

  #   - task: akeyless-get-dynamic-secret-value-task@0
  #     name: AkeylessEntraDynamic
  #     inputs:
  #       connectedServiceName: 'PersonalAkeylessVault'
  #       token: '$(AkeylessAuth.akeylessToken)'
  #       name: '/entra-id-live'
  #       timeout: 30
  #     displayName: 'Get Entra ID Dynamic Secret'

  #   - powershell: |
  #       echo "Verifying Entra Id dynamic secret..."
  #       echo "$(AkeylessEntraDynamic.dynamicSecretValue)"
  #     displayName: 'Checking Secrets'

# JOB 2
  - job: Akeyless_Custom
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureCLI@2
      name: 'AzureCLI'
      inputs:
        azureSubscription: 'Azure MSA Account'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $JWT=$(az account get-access-token --query accessToken --output tsv)
          echo "##vso[task.setvariable variable=azure_jwt;isoutput=true;issecret=true]$JWT"
      displayName: 'Get JWT from Azure Service Principal'

    # Static Secrets test
    - task: akeyless-secrets@1
      name: 'AkeylessStatic'
      inputs:
        accessid: 'p-sxfgaph9urt4om'
        azureJwt: '$(AzureCLI.azure_jwt)'
        staticSecrets: '{"/progress/TELERIK_NUGET_KEY":"nuget_key", "/docker/DOCKER_HUB_USERNAME":"docker_hub_un", "/apple/lance-apple-account-username":"apple_acct_un"}'
      displayName: 'Get Static Secrets'

    - powershell: |
        Write-Host "Result 1: $(AkeylessStatic.nuget_key)"
        Write-Host "Result 2: $(AkeylessStatic.docker_hub_un)"
        Write-Host "Result 3: $(AkeylessStatic.apple_acct_un)"
      displayName: 'Check Static Secret'

    # Dynamic secrets test
    - task: akeyless-secrets@1
      name: 'AkeylessDynamic'
      inputs:
        accessid: 'p-sxfgaph9urt4om'
        azureJwt: '$(AzureCLI.azure_jwt)'
        dynamicSecrets: '{"/az-dvlup-sqlsrvsecret":"sql_dynamic_secret", "/entra-id-live":"entra_dynamic_secret"}'
        timeout: 30
      displayName: 'Get Dynamic Secrets'

    - powershell: |
        #Write-Host "Result: $(AkeylessDynamic.sql_dynamic_secret)"
        #Write-Host "Result: $(AkeylessDynamic.entra_dynamic_secret)"

        try {
            # Remove any control characters and validate basic JSON structure
            $sqlSecretJson = "$(AkeylessDynamic.sql_dynamic_secret)" -replace '[\x00-\x1F\x7F]', ''
            $jsonObject = $sqlSecretJson | ConvertFrom-Json
            Write-Host "User: $jsonObject.user"
            Write-Host "Password: $jsonObject.password"
            Write-Host "TTL: $jsonObject.ttl_in_minute"
            Write-Host "Id: $jsonObject.id"
        } catch {
            Write-Output "Failed to parse SQL dynamic secret JSON: $($_.Exception.Message)"
        }

        try {
            $entraSecretJson = "$(AkeylessDynamic.entra_dynamic_secret)" -replace '[\x00-\x1F\x7F]', ''
            $jsonObject = $entraSecretJson | ConvertFrom-Json
            
            $keyId = $jsonObject.secret.keyId
            $displayName = $jsonObject.secret.displayName
            $appId = $jsonObject.secret.appId
            $tenantId = $jsonObject.secret.tenantId
            $secretText = $jsonObject.secret.secretText
            $endDateTime = $jsonObject.secret.endDateTime
            Write-Output "keyId: $keyId, displayName: $displayName, appId: $appId, tenantId: $tenantId, secretText: $secretText, TTL (minutes): $ttl, endDateTime: $endDateTime"
        } catch {
            Write-Output "Failed to parse Entra dynamic secret JSON: $($_.Exception.Message)"
        }
      displayName: 'Check Dynamic Secrets output'
