trigger:
  branches:
    include:
    - main
  paths:
   include:
     - 'azure-pipelines.yml'
     - 'tasks/**/*'

jobs:
  - job: Secrets_Check
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: AzureCLI@2
      name: 'AzureCLI'
      displayName: 'Get JWT from Azure Service Principal'
      inputs:
        azureSubscription: 'Azure MSA Account'
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          $JWT=$(az account get-access-token --query accessToken --output tsv)
          echo "##vso[task.setvariable variable=azure_jwt;isoutput=true;issecret=true]$JWT"

    - task: akeyless-auth@0
      name: AkeylessStatic
      inputs:
        connectedServiceName: 'PersonalAkeylessVault'
        jwt: '$(AzureCLI.azure_jwt)'

    - task: akeyless-get-secrets-value-task@0
      inputs:
        connectedServiceName: 'PersonalAkeylessVault'
        token: '$(AkeylessAuth.akeylessToken)'
        secretsPaths: 'nuget_key=/progress/TELERIK_NUGET_KEY,test_secret=/samples/azdo-test-secret'

    - powershell: echo "Your output secret is $(NUGET_KEY)"
      displayName: 'Check Static Secret output'

    - task: akeyless-get-dynamic-secret-value-task@0
      inputs:
        connectedServiceName: 'PersonalAkeylessVault'
        name: '/az-dvlup-sqlsrvsecret'
        token: '$(AkeylessAuth.akeylessToken)'
        timeout: 30

    - powershell: |
        $jsonObject = "$(AkeylessSqlDynamic.dynamicSecretValue)" | ConvertFrom-Json
        $user = $jsonObject.user
        $password = $jsonObject.password
        $ttl = $jsonObject.ttl_in_minute
        $id = $jsonObject.id
        
        Write-Host "User: $user"
        Write-Host "Password: $password"
        Write-Host "TTL: $ttl
        Write-Host "Id: $id"
      displayName: 'Check SQL Dynamic Secret output'


# Original
    # Test static secrets retrieval
    # - task: akeyless-secrets@1
    #   name: 'AkeylessStatic'
    #   displayName: 'Get Static Secrets'
    #   inputs:
    #     accessid: 'p-sxfgaph9urt4om'
    #     azureJwt: '$(AzureCLI.azure_jwt)'
    #     staticSecrets: '{"/progress/TELERIK_NUGET_KEY":"NUGET_KEY"}'

    # Test dynamic secrets retrieval
    # - task: akeyless-secrets@1
    #   name: 'AkeylessSqlDynamic'
    #   displayName: 'Get SQL Dynamic Secret'
    #   inputs:
    #     accessid: 'p-sxfgaph9urt4om'
    #     azureJwt: '$(AzureCLI.azure_jwt)'
    #     dynamicSecrets: '{"/az-dvlup-sqlsrvsecret":"sql_dynamic_secret"}'

    # - powershell: |
    #     # SQL example
    #     # "{\"user\":\"tmp_az-dvlup-sqlsr_lancedvlup_com_123AB\",\"password\":\"ABC~3eF=12345r3\",\"ttl_in_minutes\":\"60\",\"id\":\"tmp_az-dvlup-sqlsr_lancedvlup_com_123AB\"}"

    #     Write-Host "User: $(AkeylessSqlDynamic.sql_dynamic_secret)"

    #     $jsonObject = "$(AkeylessSqlDynamic.sql_dynamic_secret)" | ConvertFrom-Json
    #     $user = $jsonObject.user
    #     $password = $jsonObject.password
    #     $ttl = $jsonObject.ttl_in_minute
    #     $id = $jsonObject.id
        
    #     Write-Host "User: $user"
    #     Write-Host "Password: $password"
    #     Write-Host "TTL: $ttl
    #     Write-Host "Id: $id"
    #   displayName: 'Check SQL Dynamic Secret output'

    # - task: akeyless-secrets@1
    #   name: 'AkeylessEntraDynamic'
    #   displayName: 'Get Entra Dynamic Secret'
    #   inputs:
    #     accessid: 'p-sxfgaph9urt4om'
    #     azureJwt: '$(AzureCLI.azure_jwt)'
    #     dynamicSecrets: '{"/entra-id-live":"entra_dynamic_secret"}'

    # - powershell: |
    #     # Entra ID Response Example
    #     # "{\"secret\":{\"keyId\":\"eff4031b-8b5c-4da6-b76f-05e70790d326\",\"displayName\":\"tmp.lancedvlupcom.LzlSh\",\"secretText\":\"ABCDEFG~BW1WQNBfaQoSeWmjfSxqm123456awM\",\"appId\":\"207ff3fc-f6e3-442e-babf-55b62e047be7\",\"tenantId\":\"bd47e796-3473-4b8a-9101-1f4c0c7af31a\",\"endDateTime\":\"2025-10-01T22:44:08.5970399Z\"},\"ttl_in_minutes\":\"60\",\"id\":\"{\\\"secret_name\\\":\\\"tmp.lancedvlupcom.LzlSh\\\",\\\"secret_key_id\\\":\\\"eff4031b-8b5c-4da6-b76f-05e70790d326\\\"}\",\"msg\":\"User  has been added successfully to the following\\nGroup(s): []\\nRole(s): []\\nExpires on Tue Sep 30 23:44:09 UTC 2025\"}"

    #     Write-Host "User: $(AkeylessEntraDynamic.entra_dynamic_secret)"

    #     $jsonObject = "$(AkeylessEntraDynamic.entra_dynamic_secret)" | ConvertFrom-Json
    #     $keyId = $jsonObject.secret.keyId
    #     $displayName = $jsonObject.secret.displayName
    #     $appId = $jsonObject.secret.appId
    #     $tenantId = $jsonObject.secret.tenantId
    #     $secretText = $jsonObject.secret.secretText
    #     $endDateTime = $jsonObject.secret.endDateTime
    #     Write-Output "keyId: $keyId, displayName: $displayName, appId: $appId, tenantId: $tenantId, secretText: $secretText, TTL (minutes): $ttl, endDateTime: $endDateTime"
    #   displayName: 'Check EntraID Dynamic Secret output'